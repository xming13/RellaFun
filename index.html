<!doctype html>
<html>
	<head>
		<title>Rella Fun (three.js)</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
				
		<script src="js/threejs/Three.min.js"></script>
		<script src="js/threejs/Detector.js"></script>
		<!-- https://github.com/mrdoob/stats.js -->
		<script src="js/threejs/Stats.js"></script>
		<script src="js/threejs/OrbitControls.js"></script>
		<script src="js/threex/THREEx.KeyboardState.js"></script>
		<script src="js/threex/THREEx.screenshot.js"></script>
		<script src="js/threex/THREEx.FullScreen.js"></script>
		<script src="js/ParticleEngine.js"></script>
		<script src="js/ParticleEngineExamples.js"></script>

		<!-- jQuery code to display an information button and box when clicked. -->
		<script src="js/jquery-1.9.1.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script src="js/info.js"></script>
		
		<link  href="css/reset.css" rel="stylesheet"/>
		<link  href="css/main.css" rel="stylesheet"/>
		<link rel=stylesheet href="css/jquery-ui.css" />
		<link rel=stylesheet href="css/info.css"/>
	</head>
<body>
	<!-- three.js container -->
    <div id="container"></div>
    <!-- panel -->
    <div id="panel">
		<!-- file drop area-->
		<div id="fileDrop">
			<h1>Create your own Rella here!</h1>
			<center>
				<img src="images/drop-image.png" width="200px" />
			</center>
		</div>
		<div id="config" class="holder">
			<div class="config-set clearfix">
				<h2>Rotate Mode:</h2>
				<a href="#" id="rotate-mode-on">On</a>
				<a href="#" id="rotate-mode-off" class="disabled">Off</a>
			</div>
			<div class="config-set clearfix">
				<h2>Rain Mode:</h2>
				<a href="#" id="rain-mode-on">On</a>
				<a href="#" id="rain-mode-off" class="disabled">Off</a>
			</div>
		</div> 
		<div id="controls" class="holder">
			<h2>Controls</h2>
			- <i>1, 2, 3</i> for changing camera view
			<br />
			- <i>w, s, a, d, q, e</i> for changing rellas position
			<br />
			- <i>up, down, left, right, z, x</i> for changing camera position
			<br />
			- <i> b / n</i> for enable/disable rotate mode
			<br />
			- <i> c / v</i> for enable/disable rain mode
			<br />
			- <i>p</i> for screenshot
		</div>
		<div id="intro" class="holder">
			<h2>Notes</h2>
			<p>
				I have always imagined being able to take a photograph of the umbrellas on a rainy day from the sky.
				I think the world needs more beautiful umbrellas and rainbow.
			</p>
		</div>
		<div id="credits" class="holder">
			<h2>Credits</h2>
			<b> Many thanks to </b>
			<br />
			<a href="https://github.com/mrdoob/three.js" target="_blank">three.js</a> by <a href="https://github.com/mrdoob" target="_blank">mrdoob</a>
			<br />
			<a href="https://github.com/stemkoski/stemkoski.github.com/blob/master/Three.js/js/ParticleEngine.js" target="_blank">ParticleEngine.js</a> by <a href="https://github.com/stemkoski" target="_blank">Lee Stemkoski </a>
			<br />
			<a href="http://lab.aerotwist.com/webgl/photoparticles" target="_blank">Photo Particles</a> by <a href="aerotwist.com" target="_blank">Aerotwist<a>
		</div>
	</div>
	<div class="clear"></div>
	<div id="addFile">
		<img id="imgAddFile" src="images/icon-info.png" title="Create your own rella!" />
	</div>

	<script type="text/javascript">
		var stats, 
			scene, 
			renderer,
			camera, 
			cameraControls,
			windowResize,
			clock = new THREE.Clock(),
			keyboard = new THREEx.KeyboardState(),
			group,
			engine,
			rellaBoxSize = 20,
			rellaImage,
			fileDrop,
			isFileDropVisible = false,
			isRotateMode = true,
			currentSquareNumber;

		callbacks = {
			rotateModeOn: function() {
				isRotateMode = true;
				$(this).removeClass('disabled');
				$(this).siblings('a').addClass('disabled');
				return false;
			},
			rotateModeOff: function() {
				isRotateMode = false;
				$(this).removeClass('disabled');
				$(this).siblings('a').addClass('disabled');
				return false;
			},
			rainModeOn: function() {
				engine.destroy();
				engine = new ParticleEngine();
				engine.setValues( Examples.rain );
				engine.initialize();
				$(this).removeClass('disabled');
				$(this).siblings('a').addClass('disabled');
				return false;
			},
			rainModeOff: function() {
				engine.destroy();
				$(this).removeClass('disabled');
				$(this).siblings('a').addClass('disabled');
				return false;
			},
			showHideFileDrop: function() {
				if (isFileDropVisible) {
					hideFileDrop();
				}
				else {
					showFileDrop();
				}
				isFileDropVisible = !isFileDropVisible;
				return false;
			},
			windowResize: function() {
				var width 		= isFileDropVisible ? window.innerWidth - 300 : window.innerWidth;
				var height		= window.innerHeight;
				camera.aspect 	= width / height;
				renderer.setSize(width, height);				
				camera.updateProjectionMatrix();
			}
		};

		if( !init() )	animate();

		// init the scene
		function init(){

			if( Detector.webgl ){
				renderer = new THREE.WebGLRenderer({
					antialias		: true,	// to get smoother output
					preserveDrawingBuffer	: true	// to allow screenshot
				});
				renderer.setClearColor( 0xBBBBBB, 1 );
			// uncomment if webgl is required
			//}else{
			//	Detector.addGetWebGLMessage();
			//	return true;
			}else{
				renderer	= new THREE.CanvasRenderer();
			}
			// renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.getElementById('container').appendChild(renderer.domElement);

			// add Stats.js - https://github.com/mrdoob/stats.js
			stats = new Stats();
			stats.domElement.style.position	= 'absolute';
			stats.domElement.style.bottom	= '0px';
			document.body.appendChild( stats.domElement );

			// create a scene
			scene = new THREE.Scene();

			// put a camera in the scene
			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000 );
			camera.up = new THREE.Vector3(0,1,0);
			camera.position.set(0, 0, 150);
			camera.lookAt(scene.position);

			scene.add(camera);

			// create a camera contol
			cameraControls = new THREE.OrbitControls( camera, renderer.domElement );

			// allow 'p' to make screenshot
			THREEx.Screenshot.bindKey(renderer);
			// allow 'f' to go fullscreen where this feature is supported
			if( THREEx.FullScreen.available() ){
				THREEx.FullScreen.bindKey();		
				document.getElementById('controls').innerHTML	+= "<br/> - <i>f</i> for fullscreen";
			}

			// LIGHT
			var light = new THREE.PointLight(0xffffff);
			light.position.set(0,250,0);
			
			// SKYBOX/FOG
			var skyBoxGeometry = new THREE.CubeGeometry( 10000, 10000, 10000 );
			var skyBoxMaterial = new THREE.MeshBasicMaterial( { color: 0x9999ff, side: THREE.BackSide } );
			var skyBox = new THREE.Mesh( skyBoxGeometry, skyBoxMaterial );
		 	skyBox.flipSided = true; // render faces from inside of the cube, instead of from outside (default).
			scene.add(skyBox);
			scene.fog = new THREE.FogExp2( 0x9999ff, 0.00025 );

			// RELLA IMAGE
			rellaImage = [ 
				'MeshNormalMaterial',
				'images/rrh1.png', 
				'images/rrh2.png', 
				'images/ponybrown.png', 
				'images/watermelon.png', 
				'images/clock.png',
				'images/checkerboard.jpg',
				'images/icon-info.png', 
				'images/icon-close-16.png', 
				'images/drop-image.png',
				'images/disc.png',
				'images/crate.png',    
				'images/cloud.png',    
				'images/lava.png',
				'images/bg.png',
				'images/moon.png', 
				'images/grey-moon.png', 
				'images/earth.jpg',
				'images/rainbow.png'
			];
			var sqrtNum = Math.floor(Math.sqrt(rellaImage.length));
			currentSquareNumber = sqrtNum * sqrtNum;

			// RELLA
			group = new THREE.Object3D();
			for (var i = 0; i < rellaImage.length; i++) {
				addRella(i);
			}
			scene.add( group );

			// PARTICLE SYSTEM
			engine = new ParticleEngine();
			engine.setValues( Examples.rain );
			engine.initialize();

			// ADD Listeners
			addEventListeners();
		}

		function isPerfectSquare(i) {
			return Math.sqrt(i) % 1 == 0;
		}
		function reloadRella(numRella) {
			scene.remove(group);
			group = new THREE.Object3D();
			for (var i = 0; i < numRella; i++ ) {
				addRella(i);
			}
			scene.add(group);
		}
		function addRella(rellaImageIndex) {
			var rellaNumber = rellaImageIndex + 1;
			if (rellaNumber > currentSquareNumber && isPerfectSquare(rellaNumber)) {
				currentSquareNumber = rellaNumber;
				reloadRella(rellaNumber);
			}
			else {				
				var numRows = Math.floor(Math.sqrt(rellaImage.length));
				var startX = -1 * numRows / 2 * rellaBoxSize;
				var startZ = 0;
				var row = Math.floor(rellaImageIndex / numRows);
				var column = rellaImageIndex % numRows;
				var x = startX + row * rellaBoxSize;
				var z = startZ + column * rellaBoxSize; 
				var material;

				if (rellaImage[rellaImageIndex] == 'MeshNormalMaterial') {
					material = new THREE.MeshNormalMaterial({ side : THREE.DoubleSide  });	
				}
				else {
					var texture = new THREE.ImageUtils.loadTexture( rellaImage[rellaImageIndex] );
					material = new THREE.MeshBasicMaterial({ map: texture, side : THREE.DoubleSide  });
				}
				var geometry = new THREE.SphereGeometry(10, 8, 6, 0, Math.PI * 2, 0, Math.PI / 2.7);
				var mesh = new THREE.Mesh( geometry, material );
				mesh.position.set(x, 0, z);
				if (group.children && group.children[0]) {
					var rotation = group.children[0].rotation;
					mesh.rotation.set(rotation.x, rotation.y, rotation.z);
				}
				group.add(mesh);

				addRellaHandle(x, z);
			}
		}

		function addRellaHandle(x, z) {
			var handleL = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 13.5, 8, 1, false), 
				new THREE.MeshBasicMaterial({color: 0x000000, opacity: 1}));
      		handleL.overdraw = true;
      		handleL.position.set(x, 4, z);
      		group.add(handleL);

			var handleUBezier =  new THREE.CubicBezierCurve3( 
				new THREE.Vector3(0, 1, 0),
				new THREE.Vector3(-0.5, -1.5, 0),
				new THREE.Vector3(-2, -1.5, 0),
				new THREE.Vector3(-2.5, 1, 0)
			);

      		var handleU = new THREE.Mesh( new THREE.TubeGeometry(handleUBezier, 10, 0.3, 10, false, false), 
      			new THREE.MeshBasicMaterial({color: 0x000000, opacity: 1 }));
      		handleU.position.set(x, -3.6, z);
      		if (group.children && group.children[0]) {
				var rotation = group.children[0].rotation;
				handleU.rotation.set(rotation.x, rotation.y, rotation.z);
			}
      		group.add(handleU);	
		}


		function addEventListeners() {
			var fileDrop = document.getElementById('fileDrop');
			fileDrop.addEventListener('dragover', cancel, false);
			fileDrop.addEventListener('dragenter', cancel, false);
			fileDrop.addEventListener('dragexit', cancel, false);
			fileDrop.addEventListener('drop', dropFile, false);

			$('#rotate-mode-on').click(callbacks.rotateModeOn);
			$('#rotate-mode-off').click(callbacks.rotateModeOff);

			$('#rain-mode-on').click(callbacks.rainModeOn);
			$('#rain-mode-off').click(callbacks.rainModeOff);
			
			$('#imgAddFile').click(callbacks.showHideFileDrop);

			$(window).resize(callbacks.windowResize);
		}
		function showFileDrop() {
			renderer.setSize( window.innerWidth - 300, window.innerHeight );
			camera.aspect	= (window.innerWidth - 300) / window.innerHeight;
			camera.updateProjectionMatrix();
		}
		function hideFileDrop() {
			renderer.setSize( window.innerWidth, window.innerHeight );
			camera.aspect	= window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
		}
		function dropFile(event)
		{
			// stop the browser doing
			// it's normal thing of going
			// to the item
			event.stopPropagation();
			event.preventDefault();
			
			// query what was dropped
			var files = event.dataTransfer.files;
			
			// if we have something
			if(files.length) {
				handleFile(files[0]);
			}
			
			return false;
		}
	
		/**
		 * Handles the uploaded file
		 */
		function handleFile(file)
		{
			var fileReader 			= new FileReader();
			fileReader.onloadend	= fileUploaded;
			fileReader.readAsDataURL(file);
		}
		
		/**
		 * File upload handled
		 */
		function fileUploaded(event)
		{		
			// check it's an image
			if(event.target.result.match(/^data:image/))
			{
			    rellaImage.push(event.target.result);
			    addRella(rellaImage.length - 1);
			}
			else
			{
				// time to whinge
				alert("Umm, images only? ... Yeah");
			}
		}
		
		/**
		 * Simple handler function for 
		 * the events we don't care about
		 */
		function cancel(event)
		{
			if(event.preventDefault)
				event.preventDefault();
		
			return false;
		}

		// animation loop
		function animate() {

			// loop on request animation loop
			// - it has to be at the begining of the function
			// - see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
			requestAnimationFrame( animate );

			// do the render
			render();
			update();			
		}

		// render the scene
		function render() {
			cameraControls.update();
			renderer.render( scene, camera );
		}

		function update() {
			if (keyboard.pressed("w")) {
				group.position.z += 1;
			}
			if (keyboard.pressed("a")) {
				group.position.x += 1;
			}
			if (keyboard.pressed("s")) {
				group.position.z -= 1;
			}
			if (keyboard.pressed("d")) {
				group.position.x -= 1;
			}
			if (keyboard.pressed("q")) {
				group.position.y += 1;
			}
			if (keyboard.pressed("e")) {
				group.position.y -= 1;
			}
			if (keyboard.pressed("right")) {
				camera.position.x += 1;
			}
			if (keyboard.pressed("left")) {
				camera.position.x -= 1;
			}
			if (keyboard.pressed("up")) {
				camera.position.y += 1;
			}
			if (keyboard.pressed("down")) {
				camera.position.y -= 1;
			}
			if (keyboard.pressed("z")) {
				camera.position.z += 1;
			}
			if (keyboard.pressed("x")) {
				camera.position.z -= 1;
			}
			if (keyboard.pressed("1")) {
				camera.position.set(0, 150, 0);
				group.position.set(0, 0, -35);
			}
			if (keyboard.pressed("2")) {
				camera.position.set(0, 0, 150);
				group.position.set(0, 0, 0);
			}
			if (keyboard.pressed("3")) {
				camera.position.set(90, 70, 100);
				group.position.set(0, 0, 0);
			}
			if (keyboard.pressed("c")) {
				$('#rain-mode-on').click();
			}
			if (keyboard.pressed("v")) {
				$('#rain-mode-off').click();
			}
			if (keyboard.pressed("b")) {
				$('#rotate-mode-on').click();
			}
			if (keyboard.pressed("n")) {
				$('#rotate-mode-off').click();
			}
			if (isRotateMode) {
				group.children.forEach(function(rella) { rella.rotation.y += 0.05; })
			}

			var dt = clock.getDelta();
			if (engine) engine.update( dt * 0.5 );
			// update stats
			stats.update();
		}
	</script>
</body>
</html>
